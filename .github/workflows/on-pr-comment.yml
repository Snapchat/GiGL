name: On Demand Pr Comment Workflows

on:
  issue_comment:
    types: [created]

permissions:
  # Needed for gcloud auth: https://github.com/google-github-actions/auth
  id-token: 'write'
  contents: 'read'
  # Needed for commenting on PRs
  pull-requests: 'write'
  issues: 'write'

jobs:
  help:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/help') }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Parse available commands
      id: parse_commands
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const yaml = require('js-yaml');
          const path = '.github/workflows/on-pr-comment.yml';
          
          try {
            const content = fs.readFileSync(path, 'utf8');
            const commands = [];
            
            // Parse YAML
            const workflowData = yaml.load(content);
            
            // Process jobs from parsed YAML
            if (workflowData.jobs) {
              for (const [jobName, jobConfig] of Object.entries(workflowData.jobs)) {
                // Check if this job has a PR comment trigger
                if (jobConfig.if && jobConfig.if.includes('contains(github.event.comment.body,')) {
                  const match = jobConfig.if.match(/contains\(github\.event\.comment\.body,\s*'([^']+)'\)/);
                  if (match) {
                    const command = match[1];
                    
                    // Get description from the first step's name, or fallback to job name
                    let description = `Run ${jobName.replace(/-/g, ' ')} workflow`;
                    if (jobConfig.steps && jobConfig.steps.length > 0 && jobConfig.steps[0].name) {
                      description = jobConfig.steps[0].name;
                    }
                    
                    commands.push(`- **${command}** - ${description}`);
                  }
                }
              }
            }
            
            const helpMessage = `## ü§ñ Available PR Commands
            
          You can trigger the following workflows by commenting on this PR:
          
          ${commands.join('\n')}
          
          ---
          
          üí° **Usage:** Simply comment on this PR with any of the commands above (e.g., \`/unit_test\`)
          
          ‚è±Ô∏è **Note:** Commands may take some time to complete. Progress updates will be posted as comments.`;
            
            // Set output for the next step
            core.setOutput('help_message', helpMessage);
            
          } catch (error) {
            console.error('Error reading workflow file:', error);
            core.setOutput('help_message', '‚ùå Error: Could not read workflow file to generate help information.');
          }
    
    - name: Post help comment
      uses: snapchat/gigl/.github/actions/comment-on-pr@main
      with:
        pr_number: ${{ github.event.issue.number }}
        message: ${{ steps.parse_commands.outputs.help_message }}

  unit-test:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/unit_test') }}
    runs-on: ubuntu-latest
    timeout-minutes: 55
    steps:
    - name: Run Unit Tests
      uses: snapchat/gigl/.github/actions/run-command-on-pr@main
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        should_leave_progress_comments: "true"
        descriptive_workflow_name: "Unit Test"
        setup_gcloud: "true"
        # We use cloud run here instead of using github hosted runners because of limitation of tests
        # using GFile library (a.k.a anything that does IO w/ Tensorflow). GFile does not understand
        # how to leverage Workload Identity Federation to read assets from GCS, et al. See:
        # https://github.com/tensorflow/tensorflow/issues/57104
        use_cloud_run: "true"
        gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        gcp_service_account_email: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        command: |
          make unit_test
  integration-test:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/integration_test') }}
    runs-on: ubuntu-latest
    timeout-minutes: 70 # Tests as of 2025-05-16 are taking ~50 mins to complete, 40% buffer
    steps:
    - name: Run Integration Tests
      uses: snapchat/gigl/.github/actions/run-command-on-pr@main
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        should_leave_progress_comments: "true"
        descriptive_workflow_name: "Integration Test"
        setup_gcloud: "true"
        use_cloud_run: "true"
        gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        gcp_service_account_email: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        command: |
            make integration_test
  integration-e2e-test:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/e2e_test') }}
    runs-on: ubuntu-latest
    timeout-minutes: 155 # Tests as of 2025-05-16 are taking ~110 mins to complete, 40% buffer
    steps:
    - name: Run E2E Tests
      uses: snapchat/gigl/.github/actions/run-command-on-pr@main
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        should_leave_progress_comments: "true"
        descriptive_workflow_name: "E2E Test"
        setup_gcloud: "true"
        use_cloud_run: "true"
        gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        gcp_service_account_email: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        command: |
          make run_all_e2e_tests

  notebooks-e2e-test:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/notebook_tests') }}
    runs-on: ubuntu-latest
    timeout-minutes: 155 # Tests as of 2025-05-16 are taking ~110 mins to complete, 40% buffer
    steps:
    - name: Run Example Notebooks Tests
      uses: snapchat/gigl/.github/actions/run-command-on-pr@main
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        should_leave_progress_comments: "true"
        descriptive_workflow_name: "Example Notebooks Test"
        setup_gcloud: "true"
        use_cloud_run: "true"
        gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        gcp_service_account_email: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        command: |
          make notebooks_test


  lint-test:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/lint_test') }}
    runs-on: ubuntu-latest
    timeout-minutes: 20 # If our linting takes longer than 20 minutes something has gone very wrong...
    steps:
    - name: Run Linting Tests
      uses: snapchat/gigl/.github/actions/run-command-on-pr@main
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        should_leave_progress_comments: "true"
        descriptive_workflow_name: "Lint Test"
        install_dev_deps: "true"
        setup_gcloud: "true"
        gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        gcp_service_account_email: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        command: |
          source ~/.profile
          make check_format
          make assert_yaml_configs_parse
