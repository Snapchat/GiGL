name: Release GiGL

on:
  # Triggers the workflow manually for now until we have full support for releasing:
  # - building and releasing docker images
  # - building and releasing KFP pipeline
  workflow_dispatch:

permissions:
  contents: read
  id-token: write # Needed for the auth w/ GCP to upload to Google Artifact Registry.

jobs:
  build:
    name: Build and release pip whl
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
    environment:
      # This CI environment contains relevant pip.conf and pyprci information to
      name: release
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python deps and gcloud
      uses: ./.github/actions/setup-python-tools
      with:
          install_dev_deps: "true"
          setup_gcloud: "true"
          gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          gcp_service_account_email: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
    # We need build and twine to build the whl and upload it to Google Artifact Registry.
    # keyrings.google-artifactregistry-auth is needed to authenticate with Google Artifact Registry.
    # See: https://cloud.google.com/artifact-registry/docs/python/store-python
    # And: https://cloud.google.com/artifact-registry/docs/python/authentication
    - name: Setup environment for publishing Python package
      run: |
        # Pre-install keyring and Artifact Registry plugin from the public PyPI
        uv tool install keyring --with keyrings.google-artifactregistry-auth==1.1.2

    - name: Build Whl Distribution
      run: uv build

    - name: Publish Package ðŸš€
      env:
        PYPIRC_CONTENTS: ${{ secrets.PYPIRC_CONTENTS }}
        PIP_CONF_CONTENTS: ${{ secrets.PIP_CONF_CONTENTS }}
      # We upload the build whls to Google Artifact Registry.
      run: |
        uv publish --index gcp-release-registry --username oauth2accesstoken --keyring-provider subprocess

    - name: Post Publish Package
      if: always()
      # Clean up files created during Publish Package step.
      run: |
        rm -rf ~/.pypirc
        rm -rf ~/.pip/pip.conf
